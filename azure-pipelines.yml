variables:
  STACK_ROOT: /home/vsts/.stack
  tag: '$(Build.BuildId)'
  npm_config_cache: $(Pipeline.Workspace)/.npm

stages:
- stage: Build
  displayName: Build
  jobs:
  - job: Build
    pool:
      vmImage: 'ubuntu-18.04'
    steps:
    - script: |
        bazel build -s //app:impatience-exe
      displayName: Build server binary
    - script: |
        bazel build //:impatience.tar
      displayName: Build container
    - publish: bazel-bin/app/impatience-exe
      artifact: impatience-exe
    - publish: bazel-bin/impatience.tar
      artifact: impatience.tar
    - publish: deploycfg
      artifact: manifests
- stage: Test
  displayName: Test
  jobs:
  - job: ApiTest
    pool:
      vmImage: 'ubuntu-18.04'
    steps:
    - checkout: none
    - download: current
      artifact: test-exe
    - script: |
        bazel test --test_summary=detailed --test_output=all //...:all
      displayName: Execute Tests # (w/coverage)
    # TODO: publish test results
  - job: ImageTest
    pool:
      vmImage: 'ubuntu-18.04'
    steps:
    - script: |
        bazel test --test_summary=detailed --test_output=all //test:container_command_tests
      displayName: Execute Tests In Image
- stage: Push
  displayName: Push images
  dependsOn: Build
  jobs:
  - job: Push
    displayName: Push image to registry
    # condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    pool:
      vmImage: 'ubuntu-18.04'
    steps:
    - download: current
      artifact: impatience.tar
    - script: |
        docker load -i $(Pipeline.Workspace)/impatience.tar
      displayName: Load Image
    - task: Docker@2
      displayName: Push Image
      inputs:
        containerRegistry: 'impatienceregistry'
        repository: 'impatience'
        command: 'push'
        tags: $(tag)
- stage: Deploy
  displayName: Deploy to k8s
  dependsOn:
  - Test
  - Push
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  jobs:
  - deployment: Deploy
    displayName: Deploy to k8s
    pool:
      vmImage: 'ubuntu-18.04'
    environment: 'impatience.default'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: KubernetesManifest@0
            displayName: Create image pull secret
            inputs:
              action: createSecret
              kubernetesServiceConnection: impatienceKubernetes
              namespace: default
              secretType: dockerRegistry
              secretName: impatiencepullsecret
              dockerRegistryEndpoint: impatienceregistry
          - task: KubernetesManifest@0
            displayName: Create connection string secret
            inputs:
              action: createSecret
              kubernetesServiceConnection: impatienceKubernetes
              namespace: default
              secretType: generic
              secretName: impatience-conn
              secretArguments: --from-literal=conn-string=$(Impatience.ConnectionString)
          - task: KubernetesManifest@0
            displayName: Deploy to k8s cluster
            inputs:
              action: deploy
              kubernetesServiceConnection: impatienceKubernetes
              namespace: default
              manifests: |
                $(Pipeline.Workspace)/manifests/dev.yml
                $(Pipeline.Workspace)/manifests/service.yml
              imagePullSecrets: 'impatiencepullsecret'
              containers: impatience.azurecr.io/impatience:$(tag)
